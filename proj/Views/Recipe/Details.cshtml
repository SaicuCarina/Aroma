@model proj.Models.RecipeModel

@{
    ViewData["Title"] = "Recipe Details";
}

<div class="recipe-details">
    <h2>@Model.Title</h2>
    <div class="recipe-meta">
        <small>Posted by @Model.UserName on @Model.Date.ToString("dd MMM yyyy")</small><br>
        <small>Category: @Model.Category.CategoryName</small><br>
        <small>Difficulty: @Model.Difficulty</small><br>
        <small>Time to make: @Model.Time</small>
    </div>

    <div>
        <h3>Average Rating: @ViewBag.AverageRating.ToString("F1")</h3>
        <div class="rating-stars">
            @for (int i = 1; i <= 5; i++)
            {
                int fullParts = (int)ViewBag.AverageRating;
                double fractionalPart = ViewBag.AverageRating - fullParts;

                if (i <= fullParts)
                {
                    <span class="star filled">&#9733;</span>
                }
                else if (i == fullParts + 1 && fractionalPart >= 0.5)
                {
                    <span class="star half-filled">&#9733;</span>
                }
                else if (i == fullParts + 1 && fractionalPart > 0.1)
                {
                    <span class="star half-filled">&#9733;</span>
                }
                else
                {
                    <span class="star empty">&#9734;</span>
                }
            }
        </div>
    </div>

    <div class="recipe-content">
        <h3>Recipe Content</h3>
        <div style="white-space: pre; word-wrap: break-word;">
            @Model.Content
        </div>
    </div>

    @if (Model.PhotoPath != null)
    {
        <div class="recipe-photo">
            <img src="~/imag/@Model.PhotoPath" alt="Recipe Photo" class="img-fluid" style=" width:450px; height: 450px " />
        </div>
    }

    <br/>

    @if (Model.VideoPath != null)
    {
        <div class="recipe-video">
            <video controls="controls">
                <source src="~/imag/@Model.VideoPath" type="video/mp4" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen />
            </video>
        </div>
    }

    <div>
        <h3>Leave a Comment or Rating</h3>
        <form asp-action="Details" method="post">
            <input type="hidden" name="id" value="@Model.Id" />
            <div class="form-group">
                <label for="commentContent">Comment</label>
                <textarea id="commentContent" name="commentContent" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label for="rating">Rating</label>
                <select id="rating" name="rating" class="form-control">
                    <option value="">-- Select a rating --</option>
                    @for (int i = 1; i <= 5; i++)
                    {
                        <option value="@i">@i star@(i > 1 ? "s" : "")</option>
                    }
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <div>
        <h3>Comments</h3>
        @if (Model.Comments.Any())
        {
            foreach (var comment in Model.Comments.OrderByDescending(c => c.Date))
            {
                // Retrieve the rating for this user and recipe (if any)
                var userRating = Model.Ratings.FirstOrDefault(r => r.UserName == comment.UserName);

                <div>
                    <strong>@comment.UserName</strong>
                    @if (userRating != null)
                    {
                        <span> - Rating: @userRating.StarNumber/5</span>
                    }
                    <span> (@comment.Date.ToShortDateString()):</span>
                    <p>@comment.Content</p>
                </div>
            }
        }
        else
        {
            <p>No comments yet. Be the first to leave one!</p>
        }
    </div>

</div>


<style>
    .star {
        font-size: 24px;
        margin-right: 5px;
    }

    .filled {
        color: gold;
    }

    .half-filled {
        background: linear-gradient(to right, gold 50%, #ccc 50%);
        -webkit-background-clip: text;
        color: transparent;
        font-size: 24px;
    }

    .empty {
        color: #ccc;
    }
</style>